\section{Introduction}
\label{sec:intro}

The Elliptic Curve Digital Signature Algorithm (ECDSA) \cite{Johnson2001, ansi2005} is a digital signature scheme based on the elliptic-curve cryptography (ECC),
    widely used in many popular applications, such as TLS \cite{rfc5246}, OpenPGP \cite{openpgp2007}, smart card \cite{smartcard2007}, and Bitcoin \cite{bitcoin2008}.
The core operation of ECDSA sign/verify is the scalar multiplication of a base point (or generator) over elliptic curves
    by a random nonce (or ephemeral key).
 And the security of ECDSA relies on the intractability of the elliptic curve discrete logarithm problem (ECDLP) that
 the inability to compute the scalar (ephemeral key) given the original (base) and product points.

However, in actual implementations, the ephemeral key and the scalar multiplication need careful protection.
Side channel attacks can obtain the information on the ephemeral key during the scalar multiplication.
Furthermore, as long as some bits of the ephemeral key are leaked,
    the ECDSA private key will be recovered \cite{Nguyen2001,HG2001,Nguyen2002,Nguyen2003}.

The partial ephemeral key exposure attack was first proposed by Howgrave-Graham and Smart~\cite{HG2001} in 2001 to recover the whole DSA private key.
It was improved by Nguyen and Shparlinski \cite{Nguyen2002} and extended to ECDSA \cite{Nguyen2003}.
The basic idea is to construct a Hidden Number Problem (HNP) with the partial knowledge of the ephemeral keys,
 and then reduce to the Closest Vector Problem (CVP) or the Shortest Vector Problem (SVP) in a lattice to calculate the private key.
In 2007, the Extended Hidden Number Problem (EHNP)~\cite{ehnp} was introduced as another way to construct the problem to be solved in the lattice to recover the private key using the partial ephemeral key information.

While the cache side channel attack is an efficient way to obtain the partial information of the ephemeral key.
With the Flush+Reload cache side channels \cite{flushreload},
 attackers can get a "double-add" chain and extract some useful information about the ephemeral key.
	Benger et al. \cite{Benger2014} extracted the LSBs of the ephemeral keys from the chain and constructed an HNP instance to recover the ECDSA private key from about 200 signatures.
In 2015, Van de Pol et al.~\cite{Van2015} improved Benger's attack,
 which exploited the positions of higher half non-zero digits of the wNAF representations of the ephemeral key extracted from the "double-add" chain.
In 2016,
Fan et al.~\cite{Fan2016} extracted and utilized the information from the the "double-add" chain to
construct the EHNP to recover the private key of ECDSA.
The number of signatures needed is reduced to $4$.
In 2017, Wang et al.~\cite{Wang2017} exploited the positions of two non-zero digits together with the length of the wNAF representation of the ephemeral key to construct an HNP instance. They need 85 signatures to recover the private key.
%这一部分仍需要修改

%只是对数据分析进行了改进，并没有获得更多的数据

The above works extracted the information in the wNAF representation of the ephemeral key.
They tried to make better use of the data achieved through the side channels and construct more effective lattice attacks
 to recover the private key.
They extracted the least non-zero digit \cite{Benger2014}, half non-zero digits \cite{Van2015}, all non-zero digits \cite{Fan2016} or two non-zero digits with the total length~\cite{Wang2017}.
In summary,
all information exploited in these attacks are the positions of the non-zero digits,
 and no more extra information about the ephemeral key is extracted from the side channels.
Although the lattice attacks are different in these works,
     no effort and improvement have been made to achieve and exploit more information.

In our paper, we focus on ECDSA with the wNAF representation of the ephemeral key.
%, especially the implementation in the OpenSSL library.
 We propose a new method to recover the ECDSA private key from the information leaked through side channels.
We try to not only make better use of the information achieved from side channels,
  but also to extract different information from the side channels.
First, we analyse the implementation code of ECDSA in OpenSSL
 and find that
the invert function is another exploitable vulnerability in the implementation of the scalar multiplication.
It inverts a number so that the subtraction is replaced by addition and the space storing the precomputed points is reduced by half.
In the calculation, if the sign of current non-zero digit of the ephemeral key is opposite to the previous one, the invert function is called, and the absolute value of this digit is used to index the precomputed points. Otherwise, the invert function is not called.
It helps us to determine the sign of the non-zero digits of the wNAF representation.
 % by exploiting the \emph{$EC\_POINT\_invert()$} function we can improve the cache side channel attacks.
So we obtain the sign of the non-zero digits in the wNAF representation of the ephemeral key by adding a monitor to the invert function.
 Thus, we achieve more information about the ephemeral key compared to previous attacks.
After that, we manage to recover the consecutive bits at the position of every non-zero digits of the ephemeral key based on the information obtained from the cache side channels.
Finally, we construct an EHNP \cite{} instance making use of all the consecutive bits of the ephemeral key.
We recover the ECDSA private key by converting it to the SVP problem and solving it with lattice reduction algorithms.

This attack is applied to the secp256k1 curve in OpenSSL 1.1.1b in this paper.
We choose the Flush+Flush~\cite{gruss2016flush} attack to monitor the functions of double, add and invert.
By monitoring the  invert function
	in addition to the double and add functions in OpenSSL, %	we obtain the ``double-add-invert'' chain.
we successfully extract whether each digit of the ephemeral key is zero or not,
 and determine the signs of the non-zero digits. % from this chain.
Then we use the BKZ \cite{Schnorr1994} algorithm to solve the EHNP instance,
    and effectively recover the ECDSA private key.
If the result of the Flush+Flush attack is perfect, we only need $2$ signatures to recover the private key with a probability of $3\%$.

Through the cache side channel, we get the information about the positions and the signs of all non-zero digits of the ephemeral key.
Compared to previous works, our method obtains more information about the ephemeral key, i.e. the signs of all non-zero digits.
We extract $153.2$ bits on average per signature for 256-bit ECDSA, which makes only $2$ signatures are enough to recover the ECDSA private key.
To make better use of the obtained information of the non-zero digits,
 we exploit them to extract sequences of consecutive bits of $k$ and construct the lattice attack.
We obtain multiple consecutive bits of the ephemeral key by converting the wNAF representation to the binary representation.
And then, we use these consecutive bits to construct the EHNP instance.
To the best of our knowledge, it is the first time to obtain and exploit all the
signs of the wNAF representation in the side channel attacks against ECDSA
and our attack needs the least number of signatures to recover the ECDSA private key.

Our contributions are summarized as follows:
\begin{itemize}
  \item
  We present a new lattice attack to recover the private key of ECDSA with the wNAF representation.
  First, we
    improve the cache side channel attacks by monitoring
      the invert function.
      It is the first work to exploit the sign of the non-zero digits of the ephemeral key in side channel attacks.
   Second, for the data from the cache side channel, we do not use them to construct the EHNP instance directly,
   as in previous works.
    We obtain multiple consecutive bits of the ephemeral key by converting the wNAF representation to the binary representation.
Finally, we use these consecutive bits to construct the EHNP instance.
The private key is recovered by solving the EHNP instance using lattice reduction algorithm.
  \item
    We apply our method to the secp256k1 curve in OpenSSL1.1.0.
     Through the cache side channel, $153.2$ bits of information per signature are obtained on average.
    The experiments show that only $2$ signatures are enough to recover the private key with a probability of $3\%$.
\end{itemize}

The rest of this paper is organized as follows.
Section \ref{sec:background} presents some preliminaries.
Section \ref{sec:attack} provides the details about our attack,
and Section \ref{sec:impl&exper} shows the implementation details and the experimental results.
Section \ref{sec:discussion} contains some extended discussions.
Section \ref{sec:relatedwork} introduces some related works.
Section \ref{sec:conclusion} draws the conclusion.

%ECDSA被广泛应用
%基于椭圆曲线离散对数问题
%算法分析上难以被攻击
%但是在实现上却相对容易发现漏洞
%因此很多人通过侧信道攻击来获取软件实现上的泄露的信息，进行密钥恢复。
%Cache侧信道攻击在近年来得到广泛应用
%
%OpenSSL的实现是应用最广泛的实现。
%其中，对于素域上的椭圆曲线，使用的是wNAF算法实现的标量乘法。
%XX年，提出了对这种方式的的攻击
%XX攻击，使用Flush+Reload攻击获取了多少数据，构造了格攻击
%。。。
%在我们的文章中，我们使用了。。。做了。。。
%达到了。。。
%总的来说，本文的贡献如下：
%1、
%2、
%
%文章的剩余部分这样组织：第二章。。。。

